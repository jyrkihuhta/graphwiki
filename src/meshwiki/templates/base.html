<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ app_title }}{% endblock %}</title>
    <script>(function(){var t=localStorage.getItem('meshwiki-theme');if(t)document.documentElement.setAttribute('data-theme',t);})()</script>
    <link rel="stylesheet" href="/static/css/style.css">
    <link id="hljs-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script>(function(){var t=localStorage.getItem('meshwiki-theme');if(t==='dark'){var l=document.getElementById('hljs-theme');if(l)l.href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css';}})()</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <div class="layout">
        <header class="header">
            <a href="/" class="logo">{{ app_title }}</a>
            <button type="button" class="nav-toggle" aria-label="Toggle navigation">&#8801;</button>
            <div class="header-search">
                <input type="text" id="header-search-input" placeholder="Search..."
                    hx-get="/search"
                    hx-trigger="input changed delay:300ms"
                    hx-target="#header-search-results"
                    name="q"
                    autocomplete="off">
                <div id="header-search-results" class="search-dropdown"></div>
            </div>
            <nav class="nav">
                <a href="/">All Pages</a>
                <a href="/tags">Tags</a>
                <a href="/graph">Graph</a>
                <a href="/page/Home/edit">New Page</a>
                <button type="button" id="theme-toggle" class="btn btn-theme" aria-label="Toggle dark mode">Dark</button>
            </nav>
        </header>

        <main class="main {% block main_class %}{% endblock %}">
            {% block content %}{% endblock %}
        </main>

        <footer class="footer">
            <p>MeshWiki - A modern wiki platform</p>
        </footer>
    </div>
    <div id="loading-bar" class="loading-bar"></div>
    <div id="toast-container" class="toast-container" aria-live="polite"></div>
    <script>
    (function(){
        // Theme toggle
        var btn = document.getElementById('theme-toggle');
        if (!btn) return;
        var current = document.documentElement.getAttribute('data-theme') || 'light';
        btn.textContent = current === 'dark' ? 'Light' : 'Dark';
        btn.addEventListener('click', function() {
            var theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('meshwiki-theme', theme);
            btn.textContent = theme === 'dark' ? 'Light' : 'Dark';
            // Switch highlight.js theme
            var hljsLink = document.getElementById('hljs-theme');
            if (hljsLink) {
                hljsLink.href = theme === 'dark'
                    ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css'
                    : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
            }
        });
    })();
    // Mobile nav toggle
    (function(){
        var toggle = document.querySelector('.nav-toggle');
        var nav = document.querySelector('.nav');
        if (toggle && nav) toggle.addEventListener('click', function() {
            nav.classList.toggle('nav--open');
        });
    })();
    // Highlight code blocks on page load
    if (typeof hljs !== 'undefined') hljs.highlightAll();
    // Re-highlight after HTMX swaps (e.g. editor preview)
    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (typeof hljs !== 'undefined') {
            e.target.querySelectorAll('pre code').forEach(function(block) {
                hljs.highlightElement(block);
            });
        }
    });
    // Toast notifications
    window.showToast = function(message, type) {
        var container = document.getElementById('toast-container');
        var el = document.createElement('div');
        el.className = 'toast toast--' + (type || 'success');
        el.textContent = message;
        container.appendChild(el);
        setTimeout(function() {
            el.classList.add('toast--fade-out');
            el.addEventListener('animationend', function() { el.remove(); });
        }, 4000);
    };
    // Handle toast from redirect query param
    (function(){
        var url = new URL(window.location);
        var toast = url.searchParams.get('toast');
        if (toast) {
            url.searchParams.delete('toast');
            window.history.replaceState({}, '', url);
            var messages = {saved: 'Page saved', deleted: 'Page deleted'};
            showToast(messages[toast] || toast, 'success');
        }
    })();
    // Handle toast from HTMX HX-Trigger header
    document.body.addEventListener('showToast', function(e) {
        if (e.detail) showToast(e.detail.message, e.detail.type);
    });
    // Loading bar for HTMX requests
    (function(){
        var bar = document.getElementById('loading-bar');
        document.body.addEventListener('htmx:beforeRequest', function() {
            bar.className = 'loading-bar active';
        });
        document.body.addEventListener('htmx:afterRequest', function() {
            bar.className = 'loading-bar done';
            setTimeout(function() { bar.className = 'loading-bar'; }, 500);
        });
    })();
    </script>
    {% block extra_scripts %}{% endblock %}
</body>
</html>
